@page "/subscription"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using global::SocialMind.Shared.Models
@using global::SocialMind.Web.Data
@using global::SocialMind.Web.Services
@attribute [Authorize]
@inject ApplicationDbContext DbContext
@inject UserManager<ApplicationUser> UserManager
@inject StripePaymentService StripeService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<PageTitle>Abonelik - SocialMind</PageTitle>

<div class="subscription-container">
    @if (isLoading)
    {
        <div class="loading">Y√ºkleniyor...</div>
    }
    else if (subscription != null && plan != null)
    {
        <div class="subscription-header">
            <h1>Abonelik Y√∂netimi</h1>
            <p>Mevcut planƒ±nƒ±zƒ± y√∂netin</p>
        </div>

        <div class="subscription-content">
            <div class="current-plan-card">
                <div class="plan-badge @(plan.IsPopular ? "popular" : "")">
                    @plan.Name Plan
                </div>
                
                <div class="plan-status">
                    <span class="status-label">Durum:</span>
                    <span class="status-value @subscription.Status.ToString().ToLower()">
                        @GetStatusText(subscription.Status)
                    </span>
                </div>

                <div class="plan-price">
                    <span class="price">$@plan.MonthlyPrice.ToString("F2")</span>
                    <span class="period">/ay</span>
                </div>

                @if (subscription.IsInTrialPeriod)
                {
                    <div class="trial-info">
                        üéâ Deneme s√ºreniz @subscription.TrialEndDate?.ToString("dd MMMM yyyy") tarihinde sona erecek
                    </div>
                }

                <div class="plan-features">
                    <h3>Plana Dahil √ñzellikler:</h3>
                    <ul>
                        <li>‚úì @(plan.MaxPosts == -1 ? "Sƒ±nƒ±rsƒ±z" : plan.MaxPosts) g√∂nderi/ay</li>
                        <li>‚úì @(plan.MaxAIGenerations == -1 ? "Sƒ±nƒ±rsƒ±z" : plan.MaxAIGenerations) AI i√ßerik/ay</li>
                        <li>‚úì @plan.MaxConnectedAccounts baƒülƒ± hesap</li>
                        @if (plan.HasAdvancedAnalytics)
                        {
                            <li>‚úì Geli≈ümi≈ü analitik</li>
                        }
                        @if (plan.HasTeamCollaboration)
                        {
                            <li>‚úì Takƒ±m i≈übirliƒüi</li>
                        }
                        @if (plan.HasPrioritySupport)
                        {
                            <li>‚úì √ñncelikli destek</li>
                        }
                    </ul>
                </div>

                <div class="usage-stats">
                    <h3>Bu Ay Kullanƒ±mƒ±nƒ±z:</h3>
                    <div class="usage-item">
                        <span>G√∂nderiler:</span>
                        <strong>@subscription.PostsThisMonth / @(plan.MaxPosts == -1 ? "‚àû" : plan.MaxPosts)</strong>
                    </div>
                    <div class="usage-item">
                        <span>AI √úretimler:</span>
                        <strong>@subscription.AIGenerationsThisMonth / @(plan.MaxAIGenerations == -1 ? "‚àû" :
                                                                                plan.MaxAIGenerations)</strong>
                        </div>
                    </div>

                    <div class="subscription-actions">
                        @if (plan.Id != "free")
                        {
                            <button class="btn btn-portal" @onclick="OpenCustomerPortal">
                                üí≥ √ñdeme Y√∂netimi
                            </button>
                        
                            @if (subscription.Status == SubscriptionStatus.Active)
                            {
                                <button class="btn btn-danger" @onclick="() => showCancelDialog = true">
                                    ƒ∞ptal Et
                                </button>
                            }
                        }
                    
                        <a href="/pricing" class="btn btn-secondary">
                            Planlarƒ± Kar≈üƒ±la≈ütƒ±r
                        </a>
                    </div>
                </div>

                @if (paymentHistory.Any())
                {
                    <div class="payment-history">
                        <h2>√ñdeme Ge√ßmi≈üi</h2>
                        <div class="payment-table">
                            @foreach (var payment in paymentHistory)
                            {
                                <div class="payment-row">
                                    <div class="payment-date">
                                        @payment.CreatedAt.ToString("dd MMM yyyy")
                                    </div>
                                    <div class="payment-description">
                                        @payment.Description
                                    </div>
                                    <div class="payment-amount">
                                        @payment.Amount.ToString("C") @payment.Currency
                                    </div>
                                    <div class="payment-status @payment.Status.ToString().ToLower()">
                                        @GetPaymentStatusText(payment.Status)
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            @if (showCancelDialog)
            {
                <div class="modal-backdrop" @onclick="() => showCancelDialog = false">
                    <div class="modal-content" @onclick:stopPropagation>
                        <h2>Aboneliƒüi ƒ∞ptal Et</h2>
                        <p>Aboneliƒüinizi iptal etmek istediƒüinizden emin misiniz?</p>
                        <p class="warning">‚ö†Ô∏è ƒ∞ptal ettiƒüinizde, mevcut fatura d√∂neminin sonuna kadar eri≈üiminiz devam edecektir.
                        </p>
                    
                        <div class="modal-actions">
                            <button class="btn btn-secondary" @onclick="() => showCancelDialog = false">
                                Vazge√ß
                            </button>
                            <button class="btn btn-danger" @onclick="CancelSubscription" disabled="@isCancelling">
                                @if (isCancelling)
                                {
                                    <span>ƒ∞ptal Ediliyor...</span>
                                }
                                else
                                {
                                    <span>Evet, ƒ∞ptal Et</span>
                                }
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
    else
        {
            <div class="no-subscription">
                <h2>Aktif Abonelik Bulunamadƒ±</h2>
                <p>Bir plan se√ßerek hemen ba≈ülayƒ±n!</p>
                <a href="/pricing" class="btn btn-primary">Planlarƒ± G√∂r√ºnt√ºle</a>
            </div>
        }
    </div>

@code {
    private UserSubscription? subscription;
    private SubscriptionPlan? plan;
    private List<PaymentTransaction> paymentHistory = new();
    private bool isLoading = true;
    private bool showCancelDialog = false;
    private bool isCancelling = false;
    private string? userId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await UserManager.GetUserAsync(user);
            if (appUser != null)
            {
                userId = appUser.Id;
                await LoadSubscriptionData();
            }
        }

        isLoading = false;
    }

    private async Task LoadSubscriptionData()
    {
        if (string.IsNullOrEmpty(userId)) return;

        subscription = await DbContext.UserSubscriptions
            .Include(s => s.Plan)
            .FirstOrDefaultAsync(s => s.UserId == userId);

        if (subscription != null)
        {
            plan = subscription.Plan;
            
            paymentHistory = await DbContext.PaymentTransactions
                .Where(t => t.UserId == userId)
                .OrderByDescending(t => t.CreatedAt)
                .Take(10)
                .ToListAsync();
        }
    }

    private async Task OpenCustomerPortal()
    {
        if (string.IsNullOrEmpty(userId)) return;

        try
        {
            var returnUrl = NavigationManager.ToAbsoluteUri("/subscription").ToString();
            var portalUrl = await StripeService.CreatePortalSessionAsync(userId, returnUrl);
            NavigationManager.NavigateTo(portalUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            // Log error
            Console.WriteLine($"Portal error: {ex.Message}");
        }
    }

    private async Task CancelSubscription()
    {
        if (string.IsNullOrEmpty(userId)) return;

        isCancelling = true;

        try
        {
            var success = await StripeService.CancelSubscriptionAsync(userId);
            
            if (success)
            {
                await LoadSubscriptionData();
                showCancelDialog = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Cancel error: {ex.Message}");
        }
        finally
        {
            isCancelling = false;
        }
    }

    private string GetStatusText(SubscriptionStatus status)
    {
        return status switch
        {
            SubscriptionStatus.Active => "Aktif",
            SubscriptionStatus.Trial => "Deneme",
            SubscriptionStatus.PastDue => "√ñdeme Bekliyor",
            SubscriptionStatus.Cancelled => "ƒ∞ptal Edildi",
            SubscriptionStatus.Expired => "S√ºresi Doldu",
            _ => status.ToString()
        };
    }

    private string GetPaymentStatusText(PaymentStatus status)
    {
        return status switch
        {
            PaymentStatus.Succeeded => "Ba≈üarƒ±lƒ±",
            PaymentStatus.Failed => "Ba≈üarƒ±sƒ±z",
            PaymentStatus.Pending => "Bekliyor",
            PaymentStatus.Processing => "ƒ∞≈üleniyor",
            PaymentStatus.Refunded => "ƒ∞ade Edildi",
            PaymentStatus.Cancelled => "ƒ∞ptal Edildi",
            _ => status.ToString()
        };
    }
}

<style>
    .subscription-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .subscription-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .subscription-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 0.5rem;
    }

    .subscription-header p {
        color: #718096;
        font-size: 1.1rem;
    }

    .loading,
    .no-subscription {
        text-align: center;
        padding: 4rem 2rem;
    }

    .current-plan-card {
        background: white;
        border-radius: 16px;
        padding: 2.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }

    .plan-badge {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 20px;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }

    .plan-status {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .status-label {
        font-weight: 500;
        color: #4a5568;
    }

    .status-value {
        padding: 0.25rem 1rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .status-value.active {
        background: #c6f6d5;
        color: #22543d;
    }

    .status-value.trial {
        background: #bee3f8;
        color: #2c5282;
    }

    .status-value.cancelled {
        background: #fed7d7;
        color: #742a2a;
    }

    .plan-price {
        margin: 2rem 0;
    }

    .price {
        font-size: 3rem;
        font-weight: 700;
        color: #1a202c;
    }

    .period {
        font-size: 1.25rem;
        color: #718096;
    }

    .trial-info {
        background: #ebf8ff;
        border: 2px solid #90cdf4;
        padding: 1rem;
        border-radius: 8px;
        margin: 1.5rem 0;
        color: #2c5282;
    }

    .plan-features h3,
    .usage-stats h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1rem;
    }

    .plan-features ul {
        list-style: none;
        padding: 0;
    }

    .plan-features li {
        padding: 0.5rem 0;
        color: #4a5568;
    }

    .usage-stats {
        margin: 2rem 0;
        padding: 1.5rem;
        background: #f7fafc;
        border-radius: 8px;
    }

    .usage-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .usage-item:last-child {
        border-bottom: none;
    }

    .subscription-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
    }

    .btn-portal {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-secondary {
        background: #f7fafc;
        color: #4a5568;
        border: 2px solid #e2e8f0;
    }

    .btn-danger {
        background: #fc8181;
        color: white;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .payment-history {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .payment-history h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }

    .payment-row {
        display: grid;
        grid-template-columns: 120px 1fr 120px 100px;
        gap: 1rem;
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        align-items: center;
    }

    .payment-row:last-child {
        border-bottom: none;
    }

    .payment-status {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        text-align: center;
    }

    .payment-status.succeeded {
        background: #c6f6d5;
        color: #22543d;
    }

    .payment-status.failed {
        background: #fed7d7;
        color: #742a2a;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
    }

    .modal-content h2 {
        margin-bottom: 1rem;
    }

    .warning {
        color: #c05621;
        background: #fef5e7;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
    }

    @@media (max-width: 768px) {
        .subscription-actions {
            flex-direction: column;
        }

        .payment-row {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
    }
</style>
