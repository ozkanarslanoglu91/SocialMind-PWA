@page "/connected-accounts"
@using System.Collections.Generic
@inherits LayoutComponentBase

<div class="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-purple-900">
    <div class="p-6 sm:p-8">
        <div class="max-w-5xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">BaÄŸlÄ± Hesaplar</h1>
                <p class="text-purple-200">Sosyal medya hesaplarÄ±nÄ±zÄ± baÄŸlayÄ±p yÃ¶netin</p>
            </div>

            <!-- Status Messages -->
            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="mb-6 p-4 bg-green-500/20 border border-green-500 rounded-lg text-green-200">
                    âœ… @SuccessMessage
                </div>
            }

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="mb-6 p-4 bg-red-500/20 border border-red-500 rounded-lg text-red-200">
                    âŒ @ErrorMessage
                </div>
            }

            <!-- Platforms Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                @foreach (var platform in Platforms)
                {
                    <div
                        class="bg-white/10 backdrop-blur-md rounded-lg p-6 border border-purple-400/20 hover:border-purple-400/50 transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 bg-purple-500/30 rounded-lg flex items-center justify-center text-2xl">
                                    @GetPlatformIcon(platform.Name)
                                </div>
                                <div>
                                    <h3 class="font-bold text-white">@platform.Name</h3>
                                    <p class="text-sm text-purple-200">@GetPlatformDescription(platform.Name)</p>
                                </div>
                            </div>
                        </div>

                        @if (platform.IsConnected)
                        {
                            <div class="space-y-3">
                                @if (platform.Account != null)
                                {
                                    <div class="bg-purple-500/20 rounded p-3">
                                        @if (!string.IsNullOrEmpty(platform.Account?["ProfileImageUrl"]?.ToString()))
                                        {
                                            <img src="@platform.Account["ProfileImageUrl"]" alt="Profile"
                                                 class="w-10 h-10 rounded-full mb-2" />
                                        }
                                        <p class="text-white font-semibold">@platform.Account?["AccountName"]</p>
                                        <p class="text-xs text-purple-200">ID: @platform.Account?["AccountId"]</p>
                                        <p class="text-xs text-purple-300 mt-2">
                                            BaÄŸlÄ±: @((DateTime)platform.Account["ConnectedAt"]).ToString("dd.MM.yyyy")
                                        </p>
                                    </div>
                                }
                                <button @onclick="async () => await DisconnectAccount(platform.Id)"
                                        class="w-full px-4 py-2 bg-red-500/30 hover:bg-red-500/50 text-red-200 rounded-lg transition-colors text-sm font-semibold">
                                    BaÄŸlantÄ±yÄ± Kes
                                </button>
                            </div>
                        }
                        else
                        {
                            <button @onclick="async () => await ConnectPlatform(platform.Name)"
                                    class="w-full px-4 py-2 bg-purple-500/50 hover:bg-purple-500/70 text-white rounded-lg transition-colors font-semibold">
                                BaÄŸla
                            </button>
                        }
                    </div>
                }
            </div>

            <!-- Info Section -->
            <div class="bg-white/10 backdrop-blur-md rounded-lg p-6 border border-purple-400/20">
                <h2 class="text-xl font-bold text-white mb-4">Neden HesaplarÄ± BaÄŸlamalÄ±sÄ±nÄ±z?</h2>
                <ul class="space-y-3 text-purple-200">
                    <li class="flex items-start gap-3">
                        <span class="text-purple-400">âœ“</span>
                        <span>TÃ¼m hesaplarÄ±nÄ±zdan bir yerden post paylaÅŸÄ±n</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-purple-400">âœ“</span>
                        <span>PlanladÄ±ÄŸÄ±nÄ±z gÃ¶nderiyi otomatik olarak zamanÄ±nda yayÄ±nlayÄ±n</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-purple-400">âœ“</span>
                        <span>TÃ¼m platformlar arasÄ± analitikleri gerÃ§ek zamanlÄ± gÃ¶rÃ¼n</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-purple-400">âœ“</span>
                        <span>AI ile her platform'a Ã¶zel adaptif gÃ¶nderi oluÅŸturun</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

@code {
    private List<(string Id, string Name, bool IsConnected, Dictionary<string, object>? Account)> Platforms = new();
    private string? SuccessMessage;
    private string? ErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Query parameters'dan success/error mesajlarÄ±nÄ± al
            var uri = new Uri(NavigationManager.Uri);
            var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

            if (query.TryGetValue("success", out var successVal) && successVal == "true")
            {
                if (query.TryGetValue("platform", out var platformVal))
                {
                    SuccessMessage = $"{platformVal} hesabÄ± baÅŸarÄ±yla baÄŸlandÄ± âœ…";
                }
            }

            if (query.TryGetValue("error", out var errorVal))
            {
                ErrorMessage = $"BaÄŸlantÄ± baÅŸarÄ±sÄ±z: {System.Net.WebUtility.UrlDecode(errorVal.ToString())}";
            }

            // Connected accounts'larÄ± yÃ¼kle
            await LoadConnectedAccounts();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Hata oluÅŸtu: {ex.Message}";
        }
    }

    private async Task LoadConnectedAccounts()
    {
        try
        {
            var response = await Http.GetAsync("/api/oauth/my-accounts");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var accounts = System.Text.Json.JsonSerializer.Deserialize<List<Dictionary<string, object>>>(content,
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                Platforms = new()
                {
                    ("instagram", "Instagram", accounts?.Any(a => a["platform"]?.ToString() == "Instagram") ?? false,
                        accounts?.FirstOrDefault(a => a["platform"]?.ToString() == "Instagram")),
                    ("youtube", "YouTube", accounts?.Any(a => a["platform"]?.ToString() == "YouTube") ?? false,
                        accounts?.FirstOrDefault(a => a["platform"]?.ToString() == "YouTube")),
                    ("tiktok", "TikTok", accounts?.Any(a => a["platform"]?.ToString() == "TikTok") ?? false,
                        accounts?.FirstOrDefault(a => a["platform"]?.ToString() == "TikTok"))
                };
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Hesaplar yÃ¼klenemedi: {ex.Message}";
        }
    }

    private async Task ConnectPlatform(string platform)
    {
        try
        {
            var response = await Http.GetAsync($"/api/oauth/authorize/{platform}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var json = System.Text.Json.JsonDocument.Parse(content);
                var authUrl = json.RootElement.GetProperty("authorizationUrl").GetString();
                
                if (!string.IsNullOrEmpty(authUrl))
                {
                    NavigationManager.NavigateTo(authUrl, forceLoad: true);
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Yetkilendirme baÅŸlatÄ±lamadÄ±: {ex.Message}";
        }
    }

    private async Task DisconnectAccount(string accountId)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Bu hesabÄ±n baÄŸlantÄ±sÄ±nÄ± kesmek istediÄŸinizden emin misiniz?"))
            return;

        try
        {
            var response = await Http.PostAsync($"/api/oauth/disconnect/{accountId}", null);
            if (response.IsSuccessStatusCode)
            {
                SuccessMessage = "Hesap baÄŸlantÄ±sÄ± baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±";
                await LoadConnectedAccounts();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"BaÄŸlantÄ± kaldÄ±rÄ±lamadÄ±: {ex.Message}";
        }
    }

    private string GetPlatformIcon(string platform) => platform switch
    {
        "Instagram" => "ğŸ“·",
        "YouTube" => "â–¶ï¸",
        "TikTok" => "ğŸµ",
        _ => "ğŸ”—"
    };

    private string GetPlatformDescription(string platform) => platform switch
    {
        "Instagram" => "FotoÄŸraf ve video paylaÅŸ",
        "YouTube" => "Video yayÄ±nÄ± ve analytics",
        "TikTok" => "KÄ±sa form video iÃ§eriÄŸi",
        _ => "Sosyal medya"
    };

    [Inject]
    private HttpClient Http { get; set; } = null!;

    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;

    [Inject]
    private IJSRuntime JS { get; set; } = null!;
}
